# magicOrm 校验责任分层架构实施计划

## 项目概述

### 目标
重构 magicOrm 的校验架构，实现清晰的职责分层，支持不同 CURD 场景的差异化校验策略。

### 核心问题
1. Provider 层无法感知 CURD 场景（Insert 严格 vs Update 宽松）
2. 职责边界模糊（Database 层包含业务逻辑校验）
3. 校验策略单一，无法满足不同操作需求
4. 性能优化不足（无约束缓存）

### 设计原则
1. **Provider 负责校验**：所有数值校验在 Provider 层完成
2. **ORM/Database 负责交互**：只根据 Model 状态进行数据库操作
3. **场景差异化**：
   - Insert：严格遵循所有数值约束
   - Update：允许不修改指定字段，该字段不进行赋值校验
4. **通过 Model 屏蔽差异**：Local 和 Remote Provider 行为一致

## 实施路线图

### 阶段1：基础架构搭建（第1-2周）
**目标**：创建四层校验架构的核心模块

#### 任务1.1：创建校验核心目录结构
```
validation/
├── types/           # 基础类型校验
├── constraints/     # 业务约束校验
├── database/        # 数据库约束校验
├── scenario/        # 场景适配层
└── errors/          # 错误处理增强
```

#### 任务1.2：实现基础类型校验器 (TypeValidator)
- 基于现有 `utils/validator.go` 重构
- 添加数据类型匹配、格式验证、零值判断
- 实现类型缓存机制
- 编写单元测试（覆盖率 >90%）

#### 任务1.3：实现错误处理增强
- 创建 `ValidationError` 类型（包含字段名、约束、操作类型等信息）
- 实现 `ErrorCollector` 支持多错误收集
- 提供丰富的错误信息和格式化输出

#### 交付物：
1. 完整的校验核心模块代码
2. 单元测试套件
3. 基础接口文档

### 阶段2：Provider层扩展（第3-4周）
**目标**：扩展 Provider 接口，集成场景感知校验

#### 任务2.1：创建校验器工厂
- 实现 `ValidationFactory` 接口
- 支持配置驱动的校验器创建
- 提供默认实现和自定义扩展点

#### 任务2.2：扩展 Local Provider
- 添加 `validation_ext.go` 扩展文件
- 修改 `innerSetValue` 方法支持场景参数
- 集成场景感知校验器
- 保持向后兼容性（通过 `disableValidator` 参数）

#### 任务2.3：扩展 Remote Provider
- 确保与 Local Provider 行为一致
- 处理 JSON 序列化后的约束保持性
- 测试 Local ↔ Remote 转换的完整性
- 验证 Object/ObjectValue 的接口兼容性

#### 任务2.4：约束缓存实现
- 实现 `ConstraintCache` 缓存已解析的约束
- 实现 `ValidationCache` 缓存校验结果
- 支持 TTL 和 LRU 缓存策略
- 添加缓存统计和监控

#### 交付物：
1. 扩展的 Provider 接口和实现
2. Local/Remote Provider 的校验扩展
3. 约束缓存机制
4. 集成测试用例

### 阶段3：ORM层集成（第5-6周）
**目标**：集成校验管理器，清理 Database 层业务逻辑

#### 任务3.1：创建校验管理器
- 实现 `ValidationManager` 协调各层校验
- 支持 Insert/Update/Query/Delete 不同场景
- 提供统一的错误处理接口

#### 任务3.2：修改 Insert 操作
- 集成前置校验（调用 `ValidateForInsert`）
- 移除 Database 层的 `req` 约束检查
- 保持严格校验策略

#### 任务3.3：修改 Update 操作
- 集成场景感知校验（调用 `ValidateForUpdate`）
- 支持部分更新（跳过未修改字段的校验）
- 移除 Database 层的 `ro` 约束检查

#### 任务3.4：清理 Database 层
- 修改 `database/postgres/builder_insert.go` 移除第21-29行的 `req` 检查
- 修改 `database/postgres/builder_update.go` 移除第45-49行的 `ro` 检查
- 确保 PostgreSQL 和 MySQL builder 行为一致
- 只保留数据库相关的逻辑（SQL生成、类型映射）

#### 任务3.5：事务和关联操作集成
- 更新事务处理中的校验逻辑
- 处理嵌套对象和切片字段的校验
- 确保关联操作的一致性

#### 交付物：
1. ORM 层校验集成代码
2. 清理后的 Database 层代码
3. 事务和关联操作测试用例
4. 性能基准测试报告

### 阶段4：测试和优化（第7-8周）
**目标**：全面测试，性能优化，错误处理完善

#### 任务4.1：编写全面测试套件
- **单元测试**：各层独立功能测试（覆盖率 >90%）
- **集成测试**：完整 CURD 流程测试
- **性能测试**：新旧实现对比测试
- **兼容性测试**：行为一致性测试
- **边界测试**：异常场景和边界条件测试

#### 任务4.2：性能优化
- 基准测试：对比新旧实现的性能差异
- 缓存优化：调整缓存策略和大小
- 算法优化：优化校验算法复杂度
- 内存优化：减少内存分配和拷贝

#### 任务4.3：错误处理完善
- 测试各种错误场景（单错误、多错误、嵌套错误）
- 验证错误信息格式和可读性
- 测试错误收集器的并发安全性
- 提供错误处理最佳实践文档

#### 任务4.4：配置和调优
- 实现可配置的校验策略
- 提供性能调优指南
- 创建监控和诊断工具
- 收集生产环境反馈

#### 交付物：
1. 完整的测试报告
2. 性能优化报告
3. 错误处理最佳实践
4. 配置和调优指南

### 阶段5：迁移和文档（第9-10周）
**目标**：平滑迁移，完善文档，最终验收

#### 任务5.1：创建迁移指南
- 配置切换说明（新旧架构并行运行）
- 接口变更说明（向后兼容保障）
- 行为差异说明（Insert vs Update 策略）
- 常见问题解答和故障排除

#### 任务5.2：更新示例代码
- 更新 `test/` 目录中的测试示例
- 更新 `database/postgres/demo/` 和 `database/mysql/demo/`
- 创建新的使用示例和最佳实践
- 提供迁移工具和脚本

#### 任务5.3：更新文档
- 更新 `README.md`（添加校验架构说明）
- 更新 `AGENTS.md`（添加校验相关指南）
- 创建 `VALIDATION_ARCHITECTURE.md`（完整架构文档）
- 创建 `VALIDATION_MIGRATION_GUIDE.md`（迁移指南）
- 更新 API 文档和代码注释

#### 任务5.4：最终验收
- 运行所有测试（单元、集成、性能、兼容性）
- 验证零回归问题
- 收集用户反馈和采纳建议
- 发布正式版本和公告

#### 交付物：
1. 完整的迁移指南
2. 更新的文档和示例
3. 最终验收报告
4. 生产就绪版本

## 关键里程碑

| 里程碑 | 时间点 | 交付物 | 验收标准 |
|--------|--------|--------|----------|
| M1: 基础架构完成 | 第2周末 | 校验核心模块 | 单元测试覆盖率 >90% |
| M2: Provider扩展完成 | 第4周末 | 扩展的Provider实现 | Local/Remote行为一致 |
| M3: ORM集成完成 | 第6周末 | 集成代码和测试 | 所有CURD场景通过 |
| M4: 测试优化完成 | 第8周末 | 测试报告和优化 | 性能提升 >20% |
| M5: 迁移完成 | 第10周末 | 生产就绪版本 | 零回归问题 |

## 风险管理和缓解

### 技术风险
1. **性能下降**
   - 概率：中 | 影响：高
   - 缓解：多层缓存、算法优化、性能监控
   - 验证：基准测试对比

2. **兼容性破坏**
   - 概率：低 | 影响：高
   - 缓解：配置开关、兼容层、分阶段迁移
   - 验证：兼容性测试、用户反馈

3. **复杂度增加**
   - 概率：中 | 影响：中
   - 缓解：清晰文档、示例代码、培训
   - 验证：代码审查、用户调研

### 项目风险
4. **时间延误**
   - 概率：中 | 影响：中
   - 缓解：详细计划、定期检查、优先级管理
   - 验证：进度跟踪、里程碑评审

5. **资源不足**
   - 概率：低 | 影响：高
   - 缓解：明确需求、提前申请、调整范围
   - 验证：资源规划、风险评估

## 成功标准

### 技术成功标准
1. **功能完整性**：支持所有 CURD 场景的差异化校验
2. **性能指标**：校验性能提升 20% 以上（基准测试）
3. **代码质量**：测试覆盖率 >90%，无严重缺陷
4. **兼容性**：100% 向后兼容，无缝迁移

### 业务成功标准
1. **开发体验**：API 易用性提升，学习成本降低
2. **维护成本**：代码可维护性提升，bug 率降低
3. **系统稳定性**：生产环境零事故迁移
4. **用户满意度**：用户反馈积极，采用率高

## 资源需求

### 人力资源
- **架构师**：1人（设计和技术决策）
- **开发工程师**：2-3人（核心实现）
- **测试工程师**：1-2人（测试和验证）
- **文档工程师**：1人（文档和示例）

### 环境资源
- **开发环境**：Go 1.24+，IDE，版本控制
- **测试环境**：PostgreSQL，MySQL，性能测试工具
- **文档环境**：Markdown 编辑器，文档生成工具

### 时间资源
- **总工期**：10周（2025年2月-4月）
- **每周投入**：约 80-120 人时
- **关键评审点**：每阶段结束时的里程碑评审

## 沟通计划

### 定期沟通
- **每日站会**：进度同步，问题讨论（15分钟）
- **每周评审**：里程碑进展，风险识别（1小时）
- **每月汇报**：项目状态，成果展示（2小时）

### 沟通渠道
- **代码仓库**：GitHub Issues，Pull Requests
- **文档协作**：Markdown，Confluence
- **即时通讯**：Slack，Teams
- **会议工具**：Zoom，Google Meet

## 附录

### 相关文档
1. [校验架构设计文档] - 详细的技术设计方案
2. [接口变更影响分析] - 兼容性影响评估
3. [性能基准测试方案] - 测试方法和指标
4. [迁移操作手册] - 逐步迁移指南

### 参考实现
```go
// 示例：使用新架构进行 Insert 操作
func ExampleInsertWithEnhancedValidation() {
    // 1. 创建增强 Provider
    config := validation.Config{
        UseEnhancedValidation: true,
        Mode:                 "strict",
        EnableCache:          true,
        CacheTTL:             300,
    }
    factory := validation.NewFactory(config)
    provider := provider.NewEnhancedProvider("example", factory)
    
    // 2. 创建 Model（自动应用 Insert 场景策略）
    user := &User{
        Name:  "John Doe",
        Email: "john@example.com",
        Age:   30,
    }
    
    model, err := provider.GetEntityModel(user)
    if err != nil {
        // 处理校验错误
        log.Fatal(err)
    }
    
    // 3. ORM 操作（自动使用场景感知校验）
    orm := orm.NewOrm(provider, dbConfig)
    result, err := orm.Insert(model)
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Insert successful: %v\n", result)
}
```

### 联系方式
- **项目负责人**：[待指定]
- **技术负责人**：[待指定]
- **测试负责人**：[待指定]
- **文档负责人**：[待指定]

---
*文档版本：1.0*
*创建日期：2025-01-31*
*最后更新：2025-01-31*
*状态：实施中*

## 更新日志

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 1.0 | 2025-01-31 | 初始版本，完整的实施计划 | AI Assistant |
| 1.1 | [待更新] | 根据实施进展更新 | [待指定] |

## 批准记录

| 角色 | 姓名 | 批准日期 | 备注 |
|------|------|---------|------|
| 项目负责人 | [待指定] | [待批准] | 项目启动批准 |
| 技术负责人 | [待指定] | [待批准] | 技术方案批准 |
| 测试负责人 | [待指定] | [待批准] | 测试计划批准 |

---

**注意**：本计划为动态文档，将根据实施进展定期更新。所有重大变更需经项目负责人批准。